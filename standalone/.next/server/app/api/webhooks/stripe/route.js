"use strict";(()=>{var e={};e.id=798,e.ids=[798],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},32081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},73837:e=>{e.exports=require("util")},5334:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>w,originalPathname:()=>b,patchFetch:()=>v,requestAsyncStorage:()=>E,routeModule:()=>l,serverHooks:()=>h,staticGenerationAsyncStorage:()=>x,staticGenerationBailout:()=>m});var s={};r.r(s),r.d(s,{POST:()=>d});var o=r(95419),n=r(69108),a=r(99678),i=r(78070),u=r(7439),c=r(36814),p=r(9108);async function d(e){try{let t;if(!process.env.STRIPE_SECRET_KEY)throw Error("STRIPE_SECRET_KEY is not set");if(!process.env.STRIPE_WEBHOOK_SECRET)throw Error("STRIPE_WEBHOOK_SECRET is not set");let r=new c.Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2025-01-27.acacia",maxNetworkRetries:3}),s=process.env.STRIPE_WEBHOOK_SECRET,o=await e.text(),n=(0,u.headers)().get("stripe-signature");if(!n)return i.Z.json({error:"No stripe-signature header found"},{status:400});try{t=r.webhooks.constructEvent(o,n,s)}catch(e){return console.error("Erreur de signature du webhook:",e),i.Z.json({error:"Signature du webhook invalide"},{status:400})}switch(t.type){case"checkout.session.completed":{let e=t.data.object,r=e.client_reference_id;if(!r)throw Error("No client_reference_id found in session");let s={type:e.metadata?.subscriptionType||"STANDARD",startDate:new Date,endDate:new Date(Date.now()+(e.metadata?.duration==="yearly"?365:30)*864e5),active:!0,lastPaymentDate:new Date,stripeSubscriptionId:e.subscription};await p.Z.subscription.create({data:{...s,userId:r}});break}case"customer.subscription.deleted":{let e=t.data.object;await p.Z.subscription.updateMany({where:{stripeSubscriptionId:e.id,active:!0},data:{active:!1}});break}default:return console.log(`\xc9v\xe9nement non g\xe9r\xe9: ${t.type}`),i.Z.json({message:`\xc9v\xe9nement non g\xe9r\xe9: ${t.type}`})}return i.Z.json({received:!0})}catch(e){return console.error("Erreur dans le webhook:",e),i.Z.json({error:"Erreur interne du serveur"},{status:500})}}let l=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/webhooks/stripe/route",pathname:"/api/webhooks/stripe",filename:"route",bundlePath:"app/api/webhooks/stripe/route"},resolvedPagePath:"/home/runner/work/ExpertsPronostics/ExpertsPronostics/app/api/webhooks/stripe/route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:E,staticGenerationAsyncStorage:x,serverHooks:h,headerHooks:w,staticGenerationBailout:m}=l,b="/api/webhooks/stripe/route";function v(){return(0,a.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:x})}},9108:(e,t,r)=>{r.d(t,{Z:()=>o});let s=require("@prisma/client"),o=global.prisma||new s.PrismaClient({log:["query"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[1638,6206,7439,6814],()=>r(5334));module.exports=s})();